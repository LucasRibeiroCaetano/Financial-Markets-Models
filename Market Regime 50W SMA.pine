//@version=5
indicator("Market Regime - 50W SMA", overlay=true)

// Function to calculate regime on weekly timeframe
calc_regime() =>
    sma50 = ta.sma(close, 50)
    var int wBelow = 0
    var int wAbove = 0
    var bool bear = false
    
    if close < sma50
        wBelow += 1
        wAbove := 0
    else
        wAbove += 1
        wBelow := 0
    
    if wBelow >= 10
        bear := true
    
    if bear and wAbove >= 4
        bear := false
    
    [close, sma50, wBelow, wAbove, bear]

// Request weekly data for calculations
[weeklyClose, sma50w, weeksBelow, weeksAbove, inBearMarket] = request.security(syminfo.tickerid, "W", calc_regime())

// Determine regime color
regimeColor = color.green  // Default: Bull Market

if inBearMarket
    regimeColor := color.red  // Bear Market
else if weeklyClose < sma50w and weeksBelow < 10
    regimeColor := color.orange  // Correction

// Add background color for regime visualization
bgcolor(inBearMarket ? color.new(color.red, 95) : (weeklyClose < sma50w and weeksBelow < 10) ? color.new(color.yellow, 95) : color.new(color.green, 95))

// Display regime information
var table regimeTable = table.new(position.top_right, 2, 4, bgcolor=color.new(color.white, 10))

if barstate.islast
    table.cell(regimeTable, 0, 0, "Regime:", text_color=color.black, bgcolor=color.new(color.gray, 80))
    table.cell(regimeTable, 1, 0, inBearMarket ? "BEAR" : (weeklyClose < sma50w ? "CORRECTION" : "BULL"), 
               text_color=color.white, bgcolor=regimeColor)
    
    table.cell(regimeTable, 0, 1, "Weeks Below:", text_color=color.black, bgcolor=color.new(color.gray, 80))
    table.cell(regimeTable, 1, 1, str.tostring(weeksBelow), text_color=color.black, bgcolor=color.new(color.white, 50))
    
    table.cell(regimeTable, 0, 2, "Weeks Above:", text_color=color.black, bgcolor=color.new(color.gray, 80))
    table.cell(regimeTable, 1, 2, str.tostring(weeksAbove), text_color=color.black, bgcolor=color.new(color.white, 50))
    
    table.cell(regimeTable, 0, 3, "Price vs SMA:", text_color=color.black, bgcolor=color.new(color.gray, 80))
    table.cell(regimeTable, 1, 3, weeklyClose > sma50w ? "Above" : "Below", 
               text_color=color.black, bgcolor=color.new(color.white, 50))
