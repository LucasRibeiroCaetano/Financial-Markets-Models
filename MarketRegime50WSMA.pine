//@version=5
indicator("Market Regime - 50W SMA", overlay=true)

// Get weekly close price
weeklyClose = request.security(syminfo.tickerid, "W", close)

// Calculate 50-week SMA
sma50w = request.security(syminfo.tickerid, "W", ta.sma(close, 50))

// Variables to track regime state
var int weeksBelow = 0
var int weeksAbove = 0
var bool inBearMarket = false

// Update weekly counters
if timeframe.change("W")
    if weeklyClose < sma50w
        weeksBelow += 1
        weeksAbove := 0
    else
        weeksAbove += 1
        weeksBelow := 0
    
    // Check if we enter bear market (10+ consecutive weeks below)
    if weeksBelow >= 10
        inBearMarket := true
    
    // Check if we exit bear market (4 consecutive weeks above)
    if inBearMarket and weeksAbove >= 4
        inBearMarket := false

// Determine regime color
regimeColor = color.green  // Default: Bull Market

if inBearMarket
    regimeColor := color.red  // Bear Market
else if weeklyClose < sma50w and weeksBelow < 10
    regimeColor := color.yellow  // Correction

// Plot the 50-week SMA
plot(sma50w, "50W SMA", color=color.new(color.blue, 30), linewidth=2)

// Add background color for regime visualization
bgcolor(inBearMarket ? color.new(color.red, 95) : (weeklyClose < sma50w and weeksBelow < 10) ? color.new(color.yellow, 95) : color.new(color.green, 95))

// Display regime information
var table regimeTable = table.new(position.top_right, 2, 4, bgcolor=color.new(color.white, 10))

if barstate.islast
    table.cell(regimeTable, 0, 0, "Regime:", text_color=color.black, bgcolor=color.new(color.gray, 80))
    table.cell(regimeTable, 1, 0, inBearMarket ? "BEAR" : (weeklyClose < sma50w ? "CORRECTION" : "BULL"), 
               text_color=color.white, bgcolor=regimeColor)
    
    table.cell(regimeTable, 0, 1, "Weeks Below:", text_color=color.black, bgcolor=color.new(color.gray, 80))
    table.cell(regimeTable, 1, 1, str.tostring(weeksBelow), text_color=color.black, bgcolor=color.new(color.white, 50))
    
    table.cell(regimeTable, 0, 2, "Weeks Above:", text_color=color.black, bgcolor=color.new(color.gray, 80))
    table.cell(regimeTable, 1, 2, str.tostring(weeksAbove), text_color=color.black, bgcolor=color.new(color.white, 50))
    
    table.cell(regimeTable, 0, 3, "Price vs SMA:", text_color=color.black, bgcolor=color.new(color.gray, 80))
    table.cell(regimeTable, 1, 3, weeklyClose > sma50w ? "Above" : "Below", 
               text_color=color.black, bgcolor=color.new(color.white, 50))
