//@version=6
indicator("Value Zones", overlay=true, max_lines_count=500, max_labels_count=500)

// --- Get Weekly Close Series ---
weekly_close = request.security(syminfo.tickerid, "W", close)

// --- Compute 200-Week SMA on Weekly Data with strong smoothing ---
raw_ma200 = request.security(syminfo.tickerid, "W", ta.sma(close, 200))
smoothing_length = 20    // increase for stronger smoothing
ma200_week = ta.ema(raw_ma200, smoothing_length)  // EMA smooths better than SMA

// --- Plot 200-Week SMA ---
plot(ma200_week, "200W SMA (Smoothed)", color=color.new(color.blue, 0), linewidth=2)

// --- Fib Extension Multipliers ---
fib50  = 1.50
fib100 = 2.00
fib150 = 2.50

// --- Levels Based on Weekly SMA ---
level_verycheap = ma200_week
level_cheap     = ma200_week * fib50
level_fair      = ma200_week * fib100
level_expensive = ma200_week * fib150
level_veryexp   = ma200_week * 3.0

// --- Plot Lines ---
p_verycheap  = plot(level_verycheap,  "0% (Very Cheap)",     color=color.new(color.blue, 0))
p_cheap      = plot(level_cheap,     "50% (Cheap)",          color=color.new(color.green, 0))
p_fair       = plot(level_fair,      "100% (Fair)",          color=color.new(color.yellow, 0))
p_expensive  = plot(level_expensive, "150% (Expensive)",     color=color.new(color.red, 0))
p_veryexp    = plot(level_expensive*1.2, "Very Exp Top",     color=color.new(color.red, 0), display=display.none)

// --- Fill Zones ---
fill(p_verycheap,  p_cheap,     color=color.new(color.blue, 80))
fill(p_cheap,      p_fair,      color=color.new(color.green, 80))
fill(p_fair,       p_expensive, color=color.new(color.yellow, 80))
fill(p_expensive,  p_veryexp,   color=color.new(color.red, 80))

// --- Labels (last bar, moved far to the right) ---
if barstate.islast
    label_x = bar_index+20
    label.new(label_x, (level_verycheap + level_cheap)/2, "Very Cheap",
      style=label.style_label_left, color=color.new(color.blue, 60), textcolor=color.white, size=size.large)
    label.new(label_x, (level_cheap + level_fair)/2, "Cheap",
      style=label.style_label_left, color=color.new(color.green, 50), textcolor=color.white, size=size.large)
    label.new(label_x, (level_fair + level_expensive)/2, "Fair Value",
      style=label.style_label_left, color=color.new(color.yellow, 50), textcolor=color.white, size=size.large)
    label.new(label_x, (level_expensive + level_veryexp)/2, "Expensive",
      style=label.style_label_left, color=color.new(color.red, 60), textcolor=color.white, size=size.large)
